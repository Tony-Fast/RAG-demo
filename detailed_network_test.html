<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¦ç»†ç½‘ç»œæµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        h2 {
            color: #555;
            margin-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #666;
        }
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background-color: #f0f0f0;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        .success {
            background-color: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4CAF50;
        }
        .info {
            background-color: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }
        .log {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(76, 175, 80, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .test-result {
            margin-top: 20px;
        }
        .test-step {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .test-step.success {
            background-color: #e8f5e8;
        }
        .test-step.error {
            background-color: #ffebee;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¡ è¯¦ç»†ç½‘ç»œæµ‹è¯•å·¥å…·</h1>
        
        <div class="test-section">
            <h2>ğŸ”§ ç¯å¢ƒæ£€æµ‹</h2>
            <button onclick="testEnvironment()">å¼€å§‹ç¯å¢ƒæ£€æµ‹</button>
            <div id="environmentResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“¤ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>
            <div class="form-group">
                <label for="fileInput">é€‰æ‹©æµ‹è¯•æ–‡ä»¶ï¼š</label>
                <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.txt,.xlsx,.xls">
            </div>
            <button onclick="testFileUpload()">æµ‹è¯•æ–‡ä»¶ä¸Šä¼ </button>
            <div id="uploadResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ’¬ å¯¹è¯åŠŸèƒ½æµ‹è¯•</h2>
            <div class="form-group">
                <label for="messageInput">æµ‹è¯•æ¶ˆæ¯ï¼š</label>
                <input type="text" id="messageInput" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯" value="ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯">
            </div>
            <button onclick="testChat()">æµ‹è¯•å¯¹è¯åŠŸèƒ½</button>
            <div id="chatResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ APIè¿æ¥æµ‹è¯•</h2>
            <button onclick="testAllApis()">æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹</button>
            <div id="apiTestResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
            <div id="detailedLog" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/v1';
        let logMessages = [];
        
        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logMessages.push(logMessage);
            document.getElementById('detailedLog').textContent = logMessages.join('\n');
            console.log(logMessage);
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            logMessages = [];
            document.getElementById('detailedLog').textContent = '';
        }
        
        // åˆ›å»ºaxioså®ä¾‹
        const client = axios.create({
            baseURL: API_BASE_URL,
            timeout: 60000,
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        // æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨
        client.interceptors.request.use(
            (config) => {
                log(`å‘é€è¯·æ±‚: ${config.method?.toUpperCase()} ${config.url}`);
                log(`è¯·æ±‚æ•°æ®: ${JSON.stringify(config.data)}`);
                return config;
            },
            (error) => {
                log(`è¯·æ±‚é”™è¯¯: ${error.message}`);
                return Promise.reject(error);
            }
        );
        
        // æ·»åŠ å“åº”æ‹¦æˆªå™¨
        client.interceptors.response.use(
            (response) => {
                log(`æ”¶åˆ°å“åº”: ${response.config?.url}`);
                log(`å“åº”çŠ¶æ€: ${response.status}`);
                log(`å“åº”æ•°æ®: ${JSON.stringify(response.data)}`);
                return response;
            },
            (error) => {
                log(`å“åº”é”™è¯¯: ${error.message}`);
                log(`é”™è¯¯é…ç½®: ${JSON.stringify(error.config)}`);
                log(`é”™è¯¯å“åº”: ${JSON.stringify(error.response)}`);
                log(`é”™è¯¯ä»£ç : ${error.code}`);
                log(`é”™è¯¯å †æ ˆ: ${error.stack}`);
                return Promise.reject(error);
            }
        );
        
        // ç¯å¢ƒæ£€æµ‹
        async function testEnvironment() {
            const resultDiv = document.getElementById('environmentResult');
            resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨æ£€æµ‹ç¯å¢ƒ...';
            
            try {
                clearLog();
                log('å¼€å§‹ç¯å¢ƒæ£€æµ‹...');
                
                const results = [];
                
                // æµ‹è¯•1: æ£€æŸ¥APIåŸºç¡€URL
                results.push('<div class="test-step">');
                results.push('<strong>1. APIåŸºç¡€URL:</strong> ' + API_BASE_URL);
                results.push('</div>');
                
                // æµ‹è¯•2: æ£€æŸ¥æµè§ˆå™¨ç½‘ç»œçŠ¶æ€
                results.push('<div class="test-step">');
                results.push('<strong>2. æµè§ˆå™¨ç½‘ç»œçŠ¶æ€:</strong> ' + navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿');
                results.push('</div>');
                
                // æµ‹è¯•3: æ£€æŸ¥CORSé…ç½®
                results.push('<div class="test-step">');
                results.push('<strong>3. æµ‹è¯•CORSé…ç½®...</strong>');
                
                try {
                    const response = await fetch(API_BASE_URL + '/health', {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        results.push('<span style="color: green;">âœ… CORSé…ç½®æ­£å¸¸</span>');
                    } else {
                        results.push('<span style="color: red;">âŒ CORSé…ç½®å¯èƒ½æœ‰é—®é¢˜</span>');
                    }
                } catch (error) {
                    results.push('<span style="color: red;">âŒ CORSæµ‹è¯•å¤±è´¥: ' + error.message + '</span>');
                }
                
                results.push('</div>');
                
                // æµ‹è¯•4: æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
                results.push('<div class="test-step">');
                results.push('<strong>4. æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ...</strong>');
                
                const startTime = Date.now();
                try {
                    await fetch(API_BASE_URL + '/health');
                    const endTime = Date.now();
                    const latency = endTime - startTime;
                    results.push('<span style="color: green;">âœ… ç½‘ç»œå»¶è¿Ÿ: ' + latency + 'ms</span>');
                } catch (error) {
                    results.push('<span style="color: red;">âŒ ç½‘ç»œå»¶è¿Ÿæµ‹è¯•å¤±è´¥: ' + error.message + '</span>');
                }
                
                results.push('</div>');
                
                resultDiv.innerHTML = results.join('');
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">ç¯å¢ƒæ£€æµ‹å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        // æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
        async function testFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const resultDiv = document.getElementById('uploadResult');
            
            if (!file) {
                resultDiv.innerHTML = '<div class="error">è¯·é€‰æ‹©ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨æµ‹è¯•æ–‡ä»¶ä¸Šä¼ ...';
            
            try {
                clearLog();
                log('å¼€å§‹æ–‡ä»¶ä¸Šä¼ æµ‹è¯•...');
                log('æ–‡ä»¶å: ' + file.name);
                log('æ–‡ä»¶å¤§å°: ' + file.size + ' bytes');
                log('æ–‡ä»¶ç±»å‹: ' + file.type);
                
                const formData = new FormData();
                formData.append('file', file);
                
                log('å‡†å¤‡FormDataå®Œæˆ');
                log('å‘é€ä¸Šä¼ è¯·æ±‚...');
                
                const response = await client.post('/documents/upload', formData);
                
                log('ä¸Šä¼ æˆåŠŸï¼');
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>âœ… æ–‡ä»¶ä¸Šä¼ æµ‹è¯•æˆåŠŸï¼</h3>
                        <p><strong>æ–‡æ¡£ID:</strong> ${response.data.document_id}</p>
                        <p><strong>æ–‡ä»¶å:</strong> ${response.data.filename}</p>
                        <p><strong>æ–‡ä»¶å¤§å°:</strong> ${response.data.file_size} å­—èŠ‚</p>
                        <p><strong>å¤„ç†æ—¶é—´:</strong> ${response.data.processing_time} ç§’</p>
                        <p><strong>æ¶ˆæ¯:</strong> ${response.data.message}</p>
                    </div>
                `;
                
            } catch (error) {
                log('ä¸Šä¼ å¤±è´¥: ' + error.message);
                
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>âŒ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•å¤±è´¥ï¼</h3>
                        <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                        <p><strong>é”™è¯¯ä»£ç :</strong> ${error.code}</p>
                        <p><strong>é”™è¯¯å †æ ˆ:</strong> ${error.stack}</p>
                        <p>è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£æ›´å¤šä¿¡æ¯</p>
                    </div>
                `;
            }
        }
        
        // æµ‹è¯•å¯¹è¯åŠŸèƒ½
        async function testChat() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value;
            const resultDiv = document.getElementById('chatResult');
            
            if (!message) {
                resultDiv.innerHTML = '<div class="error">è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨æµ‹è¯•å¯¹è¯åŠŸèƒ½...';
            
            try {
                clearLog();
                log('å¼€å§‹å¯¹è¯åŠŸèƒ½æµ‹è¯•...');
                log('æµ‹è¯•æ¶ˆæ¯: ' + message);
                
                const response = await client.post('/chat/ask', {
                    question: message,
                    stream: false,
                    return_paths: true
                });
                
                log('å¯¹è¯æµ‹è¯•æˆåŠŸï¼');
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>âœ… å¯¹è¯åŠŸèƒ½æµ‹è¯•æˆåŠŸï¼</h3>
                        <p><strong>é—®é¢˜:</strong> ${response.data.question}</p>
                        <p><strong>å›ç­”:</strong> ${response.data.answer}</p>
                        <p><strong>æ¨¡å‹:</strong> ${response.data.model}</p>
                        <p><strong>å“åº”æ—¶é—´:</strong> ${response.data.response_time} ç§’</p>
                        <p><strong>æ¥æºæ•°é‡:</strong> ${response.data.sources ? response.data.sources.length : 0}</p>
                    </div>
                `;
                
            } catch (error) {
                log('å¯¹è¯æµ‹è¯•å¤±è´¥: ' + error.message);
                
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>âŒ å¯¹è¯åŠŸèƒ½æµ‹è¯•å¤±è´¥ï¼</h3>
                        <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                        <p><strong>é”™è¯¯ä»£ç :</strong> ${error.code}</p>
                        <p><strong>é”™è¯¯å †æ ˆ:</strong> ${error.stack}</p>
                        <p>è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£æ›´å¤šä¿¡æ¯</p>
                    </div>
                `;
            }
        }
        
        // æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹
        async function testAllApis() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹...';
            
            try {
                clearLog();
                log('å¼€å§‹APIç«¯ç‚¹æµ‹è¯•...');
                
                const endpoints = [
                    { name: 'å¥åº·æ£€æŸ¥', url: '/health', method: 'GET' },
                    { name: 'æ–‡æ¡£åˆ—è¡¨', url: '/documents/list', method: 'GET' },
                    { name: 'å¯¹è¯åŠŸèƒ½', url: '/chat/ask', method: 'POST', data: { question: 'æµ‹è¯•', stream: false } }
                ];
                
                const results = [];
                
                for (const endpoint of endpoints) {
                    results.push('<div class="test-step">');
                    results.push(`<strong>${endpoint.name} (${endpoint.url}):</strong>`);
                    
                    try {
                        let response;
                        if (endpoint.method === 'POST') {
                            response = await client.post(endpoint.url, endpoint.data);
                        } else {
                            response = await client.get(endpoint.url);
                        }
                        
                        results.push('<span style="color: green;"> âœ… æˆåŠŸ (çŠ¶æ€ç : ' + response.status + ')</span>');
                        log(`${endpoint.name} æµ‹è¯•æˆåŠŸï¼ŒçŠ¶æ€ç : ${response.status}`);
                        
                    } catch (error) {
                        results.push('<span style="color: red;"> âŒ å¤±è´¥: ' + error.message + '</span>');
                        log(`${endpoint.name} æµ‹è¯•å¤±è´¥: ${error.message}`);
                    }
                    
                    results.push('</div>');
                }
                
                resultDiv.innerHTML = `
                    <div class="info">
                        <h3>APIç«¯ç‚¹æµ‹è¯•ç»“æœ</h3>
                        ${results.join('')}
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">APIæµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•...');
            log('APIåŸºç¡€URL: ' + API_BASE_URL);
        };
    </script>
</body>
</html>